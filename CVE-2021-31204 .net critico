# Script para actualizar .NET Core y mitigar CVE-2021-31204

# URLs oficiales de Microsoft Update Catalog
$kb3 = "https://download.visualstudio.microsoft.com/download/pr/b140ec8a-5376-4d38-b083-f9f75c3b820d/8d87cfa323f30ab8cb909cf9a7a07e96/dotnet-sdk-3.1.115-win-x64.exe"  # KB5003251
$kb5 = "https://download.visualstudio.microsoft.com/download/pr/feac91c0-eb61-4eb7-94a1-b44e8f75e3a5/379797a7e8c7edccc0b1b62689b86c4d/dotnet-sdk-5.0.401-win-x64.exe"  # KB5003252

function Get-DotNetSdks {
    if (Get-Command dotnet -ErrorAction SilentlyContinue) {
        (& dotnet --list-sdks) -replace "\s+\[.*\]$","" | ForEach-Object {
            $sdk = $_.Split()
            [PSCustomObject]@{Version = $sdk[0]; Path = $sdk[1] }
        }
    }
}

$sdkList = Get-DotNetSdks
$sdkList | ForEach-Object {
    $ver = [version]$_.Version

    if ($ver.Major -eq 3 -and $ver.Minor -eq 1 -and $ver -lt [version]"3.1.15") {
        Write-Host "Encontrada versión vulnerable .NET SDK $_.Version → Se instalará 3.1.15..."
        $file = "$env:TEMP\dotnet31.exe"
        Invoke-WebRequest $kb3 -OutFile $file
        Start-Process $file -ArgumentList "/quiet /norestart" -Wait
        Remove-Item $file
    }

    if ($ver.Major -eq 5 -and $ver -lt [version]"5.0.6") {
        Write-Host "Encontrada versión vulnerable .NET SDK $_.Version → Se instalará 5.0.6..."
        $file = "$env:TEMP\dotnet50.exe"
        Invoke-WebRequest $kb5 -OutFile $file
        Start-Process $file -ArgumentList "/quiet /norestart" -Wait
        Remove-Item $file
    }
}

Write-Host "Proceso finalizado. Reinicie el servidor para completar la mitigación."
