# ================================
# Script: Cleanup Old .NET Frameworks
# ================================

# Define la versión mínima que quieres mantener
$minFrameworkVersion = "4.8.1"  # Cambia según la versión que quieras mantener

Write-Host "Detectando versiones instaladas de .NET Framework..."

# Buscar en el registro
$uninstallPaths = @(
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall",
    "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall"
)

$installedFrameworks = @()

foreach ($path in $uninstallPaths) {
    $keys = Get-ChildItem $path -ErrorAction SilentlyContinue
    foreach ($key in $keys) {
        $props = Get-ItemProperty $key.PSPath -ErrorAction SilentlyContinue
        if ($props.DisplayName -match "Microsoft .NET Framework" -and $props.DisplayVersion) {
            $installedFrameworks += [PSCustomObject]@{
                Name = $props.DisplayName
                Version = $props.DisplayVersion
                UninstallString = $props.UninstallString
            }
        }
    }
}

if ($installedFrameworks.Count -eq 0) {
    Write-Host "No se encontraron versiones de .NET Framework instaladas."
    return
}

Write-Host "Frameworks encontrados:"
$installedFrameworks | ForEach-Object { Write-Host "$($_.Name) - $($_.Version)" }

# Filtrar y desinstalar versiones anteriores a la mínima
foreach ($fw in $installedFrameworks) {
    try {
        if ([version]$fw.Version -lt [version]$minFrameworkVersion) {
            Write-Host "Desinstalando $($fw.Name) versión $($fw.Version)..."
            if ($fw.UninstallString) {
                Start-Process -FilePath "cmd.exe" -ArgumentList "/c $($fw.UninstallString) /quiet /norestart" -Wait
                Write-Host "Desinstalación completada: $($fw.Name)"
            } else {
                Write-Warning "No se encontró cadena de desinstalación para $($fw.Name)"
            }
        }
    } catch {
        Write-Warning "Error procesando $($fw.Name): $_"
    }
}

Write-Host "Proceso de limpieza de .NET Framework completado."
