<#
    Script para detectar instalaciones vulnerables de Apache Flink (CVE-2020-9493)
    - Busca carpetas/flink*.jar en todo C:\
    - Reporta versiones encontradas y si son vulnerables
#>

Write-Host "`nBuscando instalaciones de Apache Flink en C:\ ..." -ForegroundColor Cyan
$flinkJars = Get-ChildItem -Path C:\ -Recurse -Include flink-dist_*.jar,flink-runtime_*.jar -ErrorAction SilentlyContinue

if (!$flinkJars) {
    Write-Host "No se encontraron archivos de Flink en C:\" -ForegroundColor Yellow
    exit
}

foreach ($jar in $flinkJars) {
    $version = [regex]::Match($jar.Name, "\d+\.\d+\.\d+").Value
    Write-Host "`nArchivo encontrado: $($jar.FullName)"
    if ($version) {
        Write-Host "Versión detectada: $version"
        if (($version -lt "1.9.3") -or (($version -ge "1.10.0") -and ($version -lt "1.10.1"))) {
            Write-Host "-> Esta versión es VULNERABLE a CVE-2020-9493. Actualiza Flink." -ForegroundColor Red
        } else {
            Write-Host "-> Esta versión NO es vulnerable a CVE-2020-9493." -ForegroundColor Green
        }
    } else {
        Write-Host "No se pudo determinar la versión del archivo, revisa manualmente." -ForegroundColor Yellow
    }
}

Write-Host "`nDescarga la última versión de Flink aquí: https://flink.apache.org/downloads.html"
Write-Host "Referencia CVE: https://nvd.nist.gov/vuln/detail/CVE-2020-9493"
