# Get-VCRedistVersion.ps1
# Obtiene las versiones instaladas del Microsoft Visual C++ Redistributable
# Compatible con VC++ 2015, 2017, 2019, 2022 (todos usan la misma base)

# --- Función: Obtener versión de VC++ desde el registro ---
function Get-VCRedistVersion {
    $uninstallKeys = @(
        'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*'
        'HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*'
    )

    $vcEntries = Get-ItemProperty $uninstallKeys -ErrorAction SilentlyContinue | Where-Object {
        $_.DisplayName -like "Microsoft Visual C++ * Redistributable*" -and
        $_.DisplayName -notlike "*Language Pack*"
    }

    $results = @()
    foreach ($entry in $vcEntries) {
        $name = $entry.DisplayName
        $version = $entry.DisplayVersion
        $arch = if ($name -match "x64") { "x64" } elseif ($name -match "x86") { "x86" } else { "Unknown" }

        $results += [PSCustomObject]@{
            Name     = $name
            Version  = $version
            Arch     = $arch
            InstallDate = $entry.InstallDate
        }
    }

    return $results | Sort-Object Version -Descending
}

# --- Ejecución ---
Write-Host "`n🔍 Buscando Visual C++ Redistributable instalado..." -ForegroundColor Cyan

$vcList = Get-VCRedistVersion

if ($vcList.Count -eq 0) {
    Write-Host "❌ No se encontró ningún Microsoft Visual C++ Redistributable." -ForegroundColor Red
} else {
    Write-Host "✅ Se encontraron $($vcList.Count) versiones de VC++ Redistributable:" -ForegroundColor Green
    $vcList | Format-Table -AutoSize
}

# --- Recomendación ---
$latest = "14.40.33807.0"  # Versión más reciente de VC++ 2015-2022 (v14.40+)
$latestFound = $vcList | Where-Object { [version]$_.Version -ge [version]"14.30.0" } | Select-Object -First 1

if (-not $latestFound) {
    Write-Host "`n⚠️  No se encontró una versión reciente de VC++ (>= 14.30)." -ForegroundColor Yellow
    Write-Host "💡 Descarga la última versión desde:" -ForegroundColor White
    Write-Host "🔗 https://aka.ms/vs/17/release/vc_redist.x64.exe" -ForegroundColor Blue
    Write-Host "🔗 https://aka.ms/vs/17/release/vc_redist.x86.exe" -ForegroundColor Blue
} else {
    Write-Host "`n✅ Tu sistema tiene una versión moderna de VC++: $($latestFound.Version)" -ForegroundColor Green
}
