# Ejecutar como Administrador e Internet activo

function Get-DotNetFrameworkVersionFromRelease($release) {
    switch ($release) {
        { $_ -ge 533325 } { return ".NET Framework 4.8.1 o superior"; break }
        { $_ -ge 528040 } { return ".NET Framework 4.8"; break }
        { $_ -ge 461808 } { return ".NET Framework 4.7.2"; break }
        { $_ -ge 461308 } { return ".NET Framework 4.7.1"; break }
        { $_ -ge 460798 } { return ".NET Framework 4.7"; break }
        { $_ -ge 394802 } { return ".NET Framework 4.6.2"; break }
        { $_ -ge 394254 } { return ".NET Framework 4.6.1"; break }
        { $_ -ge 393295 } { return ".NET Framework 4.6"; break }
        { $_ -ge 379893 } { return ".NET Framework 4.5.2"; break }
        { $_ -ge 378675 } { return ".NET Framework 4.5.1"; break }
        { $_ -ge 378389 } { return ".NET Framework 4.5"; break }
        default { return "Versión desconocida o anterior a 4.5" }
    }
}

# Paso 1: Detectar .NET Framework
Write-Host "Detectando versiones instaladas de .NET Framework..." -ForegroundColor Cyan
$netFrameworks = Get-ChildItem 'HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP' -Recurse |
    Get-ItemProperty -ErrorAction SilentlyContinue |
    Where-Object { $_.Version -or $_.Release -or $_.PSChildName -match '^(?!S)\p{L}.*' } |
    Select-Object PSChildName, Version, Release, Install, InstallPath

$found = $false
$highestRelease = 0

foreach ($fw in $netFrameworks) {
    if ($fw.Version) {
        Write-Host "Encontrada: $($fw.PSChildName)  Version: $($fw.Version)"
        $found = $true
    } elseif ($fw.Release) {
        $ver = Get-DotNetFrameworkVersionFromRelease $fw.Release
        Write-Host "Encontrada: $($fw.PSChildName)  Release: $($fw.Release)  [$ver]"
        $found = $true
        if ($fw.Release -gt $highestRelease) { $highestRelease = $fw.Release }
    }
}

# Paso 2: Descargar e instalar .NET Framework 4.8.1 si es necesario
$ultimaRelease = 533325 # 4.8.1
if ($highestRelease -ge $ultimaRelease) {
    Write-Host "`nYa tienes instalada la última versión de .NET Framework (4.8.1 o superior)." -ForegroundColor Green
} else {
    Write-Host "`nActualizando automáticamente a .NET Framework 4.8.1..." -ForegroundColor Cyan
    $url = "https://download.visualstudio.microsoft.com/download/pr/d0a0d32f-3e09-4a7c-8d2e-4e3a2f7e0e0b/ab6e1f5f7f6ed97b9d4a74c0cf1e2f46/ndp481-x86-x64-allos-enu.exe"
    $file = "$env:TEMP\ndp481-x86-x64-allos-enu.exe"

    Write-Host "Descargando instalador desde $url..."
    try {
        Invoke-WebRequest -Uri $url -OutFile $file -UseBasicParsing
    } catch {
        Write-Host "Error descargando el instalador. Detalle: $_" -ForegroundColor Red
    }

    if (Test-Path $file) {
        Write-Host "Ejecutando instalador en modo silencioso..."
        Start-Process -FilePath $file -ArgumentList "/quiet", "/norestart" -Wait
        Write-Host "`nInstalación completada. Es recomendable reiniciar el equipo para finalizar la actualización de .NET Framework." -ForegroundColor Green
        Remove-Item $file -Force
    } else {
        Write-Host "No se pudo descargar el instalador. Verifica tu conexión a internet." -ForegroundColor Red
    }
}

# Paso 3: Detectar e instalar .NET SDK 8.0 si es necesario
Write-Host "`nBuscando SDKs de .NET Core/.NET instalado..." -ForegroundColor Green
$dotnetInstalled = Get-Command "dotnet" -ErrorAction SilentlyContinue
$hasDotnet8 = $false
if ($dotnetInstalled) {
    $sdks = dotnet --list-sdks
    Write-Host "SDKs instalados:" -ForegroundColor White
    $sdks
    foreach ($sdk in $sdks) {
        if ($sdk -match "^8\.") { $hasDotnet8 = $true }
    }
} else {
    Write-Host "El comando 'dotnet' no está disponible en el PATH." -ForegroundColor Yellow
}

if ($hasDotnet8) {
    Write-Host "`nYa tienes instalado .NET SDK 8." -ForegroundColor Green
} else {
    Write-Host "`n.NET SDK 8 no detectado. Intentando instalar automáticamente..." -ForegroundColor Cyan
    # Intentar con winget primero
    if (Get-Command "winget" -ErrorAction SilentlyContinue) {
        Write-Host "Instalando .NET SDK 8 usando winget..."
        winget install --id Microsoft.DotNet.SDK.8 --silent --accept-package-agreements --accept-source-agreements
        Write-Host "Instalación de .NET SDK 8 finalizada (verifica posibles mensajes en la consola)." -ForegroundColor Green
    } else {
        # Descargar el instalador oficial offline de .NET SDK 8.0 x64 (ajusta si requieres ARM/x86)
        $dotnet8Url = "https://download.visualstudio.microsoft.com/download/pr/13e7b346-23e4-4e48-9a56-5e93c3ba3e3b/9a08f7c0b31b5eb4b3ae82e9e9e8e6d2/dotnet-sdk-8.0.100-win-x64.exe"
        $dotnet8File = "$env:TEMP\dotnet-sdk-8.0.100-win-x64.exe"
        Write-Host "Descargando instalador de .NET SDK 8 desde $dotnet8Url..."
        try {
            Invoke-WebRequest -Uri $dotnet8Url -OutFile $dotnet8File -UseBasicParsing
        } catch {
            Write-Host "Error descargando el instalador de .NET SDK 8. Detalle: $_" -ForegroundColor Red
        }

        if (Test-Path $dotnet8File) {
            Write-Host "Ejecutando instalador de .NET SDK 8 en modo silencioso..."
            Start-Process -FilePath $dotnet8File -ArgumentList "/install", "/quiet", "/norestart" -Wait
            Write-Host "Instalación de .NET SDK 8 finalizada. Es recomendable reiniciar el equipo." -ForegroundColor Green
            Remove-Item $dotnet8File -Force
        } else {
            Write-Host "No se pudo descargar el instalador de .NET SDK 8. Descárgalo manualmente desde https://dotnet.microsoft.com/es-es/download/dotnet/8.0" -ForegroundColor Red
        }
    }
}

Write-Host "`nPasos realizados:"
Write-Host "1. Detección de versiones instaladas de .NET Framework."
Write-Host "2. Descarga e instalación automática de .NET Framework 4.8.1 si era necesario."
Write-Host "3. Detección de SDKs de .NET Core/.NET instalados."
Write-Host "4. Instalación/actualización automática de .NET SDK 8 usando winget o instalador oficial."
Write-Host "`n**Reinicia el sistema después de la actualización para aplicar los cambios correctamente.**" -ForegroundColor Magenta
