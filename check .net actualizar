# Detectar todas las versiones de .NET Framework instaladas y actualizar automáticamente a la última versión (4.8.1)
# Se requiere ejecutar como Administrador

Write-Host "Detectando versiones instaladas de .NET Framework..." -ForegroundColor Cyan

function Get-DotNetFrameworkVersionFromRelease($release) {
    switch ($release) {
        { $_ -ge 533325 } { return ".NET Framework 4.8.1 o superior"; break }
        { $_ -ge 528040 } { return ".NET Framework 4.8"; break }
        { $_ -ge 461808 } { return ".NET Framework 4.7.2"; break }
        { $_ -ge 461308 } { return ".NET Framework 4.7.1"; break }
        { $_ -ge 460798 } { return ".NET Framework 4.7"; break }
        { $_ -ge 394802 } { return ".NET Framework 4.6.2"; break }
        { $_ -ge 394254 } { return ".NET Framework 4.6.1"; break }
        { $_ -ge 393295 } { return ".NET Framework 4.6"; break }
        { $_ -ge 379893 } { return ".NET Framework 4.5.2"; break }
        { $_ -ge 378675 } { return ".NET Framework 4.5.1"; break }
        { $_ -ge 378389 } { return ".NET Framework 4.5"; break }
        default { return "Versión desconocida o anterior a 4.5" }
    }
}

# Buscar en el registro todas las versiones de .NET Framework instaladas
$netFrameworks = Get-ChildItem 'HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP' -Recurse |
    Get-ItemProperty -ErrorAction SilentlyContinue |
    Where-Object { $_.Version -or $_.Release -or $_.PSChildName -match '^(?!S)\p{L}.*' } |
    Select-Object PSChildName, Version, Release, Install, InstallPath

$found = $false
$highestRelease = 0

foreach ($fw in $netFrameworks) {
    if ($fw.Version) {
        Write-Host "Encontrada: $($fw.PSChildName)  Version: $($fw.Version)"
        $found = $true
    } elseif ($fw.Release) {
        $ver = Get-DotNetFrameworkVersionFromRelease $fw.Release
        Write-Host "Encontrada: $($fw.PSChildName)  Release: $($fw.Release)  [$ver]"
        $found = $true
        if ($fw.Release -gt $highestRelease) { $highestRelease = $fw.Release }
    }
}

if (-not $found) {
    Write-Host "No se detectaron versiones de .NET Framework instaladas." -ForegroundColor Yellow
}

# Comprobar si ya está instalada la última versión estable (4.8.1)
$ultimaRelease = 533325 # Release key para 4.8.1
if ($highestRelease -ge $ultimaRelease) {
    Write-Host "`nYa tienes instalada la última versión de .NET Framework (4.8.1)." -ForegroundColor Green
} else {
    # Descargar e instalar automáticamente .NET Framework 4.8.1 (requiere internet y privilegios de admin)
    Write-Host "`nActualizando automáticamente a .NET Framework 4.8.1..." -ForegroundColor Cyan

    # URL oficial Microsoft para el instalador offline de 4.8.1
    $url = "https://download.visualstudio.microsoft.com/download/pr/d0a0d32f-3e09-4a7c-8d2e-4e3a2f7e0e0b/ab6e1f5f7f6ed97b9d4a74c0cf1e2f46/ndp481-x86-x64-allos-enu.exe"
    $file = "$env:TEMP\ndp481-x86-x64-allos-enu.exe"

    Write-Host "Descargando instalador desde $url..."
    Invoke-WebRequest -Uri $url -OutFile $file

    if (Test-Path $file) {
        Write-Host "Ejecutando instalador en modo silencioso..."
        Start-Process -FilePath $file -ArgumentList "/quiet", "/norestart" -Wait

        Write-Host "`nInstalación completada. Es recomendable reiniciar el equipo para finalizar la actualización de .NET Framework." -ForegroundColor Green
        Remove-Item $file -Force
    } else {
        Write-Host "No se pudo descargar el instalador. Verifica tu conexión a internet." -ForegroundColor Red
    }
}

# Extra: Detectar .NET Core y .NET 5+ instalados
Write-Host "`nBuscando SDKs de .NET Core/.NET 5+ instalados..." -ForegroundColor Green
if (Get-Command "dotnet" -ErrorAction SilentlyContinue) {
    dotnet --list-sdks
    Write-Host "Puedes actualizar .NET Core/.NET con winget: winget upgrade Microsoft.DotNet.SDK.8" -ForegroundColor Cyan
    Write-Host "O desde: https://dotnet.microsoft.com/es-es/download" -ForegroundColor Cyan
} else {
    Write-Host "El comando 'dotnet' no está disponible en el PATH." -ForegroundColor Yellow
}
