# Script alternativo para detectar y actualizar .NET Framework y .NET SDK 8 en Windows
# Debe ejecutarse como Administrador
# Descarga los instaladores sólo si faltan las versiones recomendadas

function Obtener-VersionDotNetFramework {
    $regKey = "HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full"
    if (Test-Path $regKey) {
        $release = (Get-ItemProperty $regKey -ErrorAction SilentlyContinue).Release
        return $release
    }
    return 0
}

function Instalar-DotNetFramework481 {
    $url = "https://download.visualstudio.microsoft.com/download/pr/d0a0d32f-3e09-4a7c-8d2e-4e3a2f7e0e0b/ab6e1f5f7f6ed97b9d4a74c0cf1e2f46/ndp481-x86-x64-allos-enu.exe"
    $file = "$env:TEMP\ndp481-x86-x64-allos-enu.exe"
    Write-Host "Descargando .NET Framework 4.8.1..."
    Invoke-WebRequest -Uri $url -OutFile $file -UseBasicParsing
    if (Test-Path $file) {
        Write-Host "Instalando .NET Framework 4.8.1, espere..."
        Start-Process -FilePath $file -ArgumentList "/quiet", "/norestart" -Wait
        Remove-Item $file -Force
        Write-Host ".NET Framework 4.8.1 instalado. Reinicie el equipo para completar la instalación." -ForegroundColor Green
    } else {
        Write-Host "No se pudo descargar el instalador de .NET Framework 4.8.1." -ForegroundColor Red
    }
}

function Obtener-SDKsDotNet8 {
    $dotnet = Get-Command "dotnet" -ErrorAction SilentlyContinue
    if (!$dotnet) { return $false }
    $sdks = dotnet --list-sdks 2>$null
    foreach ($sdk in $sdks) { if ($sdk -match "^8\.") { return $true } }
    return $false
}

function Instalar-DotNetSDK8 {
    $sdkUrl = "https://download.visualstudio.microsoft.com/download/pr/13e7b346-23e4-4e48-9a56-5e93c3ba3e3b/9a08f7c0b31b5eb4b3ae82e9e9e8e6d2/dotnet-sdk-8.0.100-win-x64.exe"
    $sdkFile = "$env:TEMP\dotnet-sdk-8.0.100-win-x64.exe"
    Write-Host "Descargando .NET SDK 8.0..."
    Invoke-WebRequest -Uri $sdkUrl -OutFile $sdkFile -UseBasicParsing
    if (Test-Path $sdkFile) {
        Write-Host "Instalando .NET SDK 8.0, espere..."
        Start-Process -FilePath $sdkFile -ArgumentList "/install", "/quiet", "/norestart" -Wait
        Remove-Item $sdkFile -Force
        Write-Host ".NET SDK 8.0 instalado correctamente." -ForegroundColor Green
    } else {
        Write-Host "No se pudo descargar el instalador de .NET SDK 8." -ForegroundColor Red
    }
}

# --- Proceso principal ---
Write-Host "`n[1/3] Comprobando .NET Framework 4.8.1..."
$release = Obtener-VersionDotNetFramework
if ($release -ge 533325) {
    Write-Host ".NET Framework 4.8.1 ya está instalado." -ForegroundColor Green
} else {
    Instalar-DotNetFramework481
}

Write-Host "`n[2/3] Comprobando .NET SDK 8..."
if (Obtener-SDKsDotNet8) {
    Write-Host ".NET SDK 8 ya está instalado." -ForegroundColor Green
} else {
    Instalar-DotNetSDK8
}

Write-Host "`n[3/3] Proceso finalizado."
Write-Host "Si se instalaron nuevas versiones, reinicie el equipo para completar la actualización." -ForegroundColor Cyan
