# Ejecutar como Administrador
# Soluciona CVE-2024-38081 en .NET 8 y Visual Studio

# Función para detectar versiones de .NET SDK instaladas
function Get-DotNetSdkVersions {
    if (Get-Command "dotnet" -ErrorAction SilentlyContinue) {
        return (dotnet --list-sdks) -replace "\s+\[.*\]$",""
    }
    return @()
}

# Instalar/Actualizar .NET SDK 8.0.8 (o superior, parcheado)
function Install-DotNetSdk808 {
    $sdkUrl = "https://download.visualstudio.microsoft.com/download/pr/1e3d9e6c-8e58-4d3e-8b6e-2f8be2b7f6e1/2b7e4e6c2f5e46a2b2c7a2e4f6c8a6e2/dotnet-sdk-8.0.8-win-x64.exe"
    $sdkFile = "$env:TEMP\dotnet-sdk-8.0.8-win-x64.exe"
    Write-Host "Descargando .NET SDK 8.0.8 (parche CVE-2024-38081)..."
    Invoke-WebRequest -Uri $sdkUrl -OutFile $sdkFile
    Write-Host "Instalando .NET SDK 8.0.8..."
    Start-Process -FilePath $sdkFile -ArgumentList "/install", "/quiet", "/norestart" -Wait
    Remove-Item $sdkFile -Force
    Write-Host ".NET SDK actualizado a 8.0.8 o superior."
}

# Paso 1: Detectar si necesitas actualizar .NET SDK
$sdkVersions = Get-DotNetSdkVersions
$parcheado = $false
foreach ($ver in $sdkVersions) {
    if ($ver -match "^8\.0\.(8|[9-9]\d+|\d{3,})") { $parcheado = $true }
}
if ($parcheado) {
    Write-Host ".NET SDK 8.0.8 o superior ya está instalado. Ya no eres vulnerable a CVE-2024-38081." -ForegroundColor Green
} else {
    Install-DotNetSdk808
}

# Paso 2: Recomendar actualización de Visual Studio
Write-Host "`nAbriendo el instalador de Visual Studio para aplicar todas las actualizaciones de seguridad..."
$vsInstaller = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\Installer.exe"
if (Test-Path $vsInstaller) {
    Start-Process -FilePath $vsInstaller
    Write-Host "Sigue las instrucciones en el instalador de Visual Studio para aplicar los últimos parches."
} else {
    Write-Host "No se encontró el instalador de Visual Studio. Actualízalo manualmente desde: https://visualstudio.microsoft.com/downloads/"
}

Write-Host "`nReferencia oficial: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-38081"
Write-Host "¡Reinicia tu equipo después de actualizar para completar la mitigación!" -ForegroundColor Cyan
