# ===============================================================
# Script: Mitigate-CVE-2025-29803-SSMS.ps1
# Propósito: Detectar SSMS y actualizarlo para mitigar CVE-2025-29803
# ===============================================================

$logFile = "C:\Logs\SSMS_Update.log"
if (!(Test-Path "C:\Logs")) { New-Item -ItemType Directory -Path "C:\Logs" | Out-Null }

Add-Content -Path $logFile -Value "$(Get-Date) - Inicio de mitigación CVE-2025-29803"

# Buscar SSMS instalado
$keys = @(
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall",
    "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall"
)

$ssmsFound = $false
foreach ($reg in $keys) {
    Get-ChildItem $reg | ForEach-Object {
        $p = Get-ItemProperty $_.PsPath -ErrorAction SilentlyContinue
        if ($p.DisplayName -match "SQL Server Management Studio") {
            $ssmsFound = $true
            $ssmsVersion = $p.DisplayVersion
            $ssmsPath    = $p.InstallLocation
            Write-Host "SSMS detectado: $($p.DisplayName) - Versión: $ssmsVersion"
            Add-Content -Path $logFile -Value "$(Get-Date) - SSMS detectado: $($p.DisplayName) - Versión: $ssmsVersion"
        }
    }
}

if (-not $ssmsFound) {
    Write-Host "No se detectó SSMS instalado. No se requiere mitigación."
    Add-Content -Path $logFile -Value "$(Get-Date) - No se detectó SSMS instalado."
    exit
}

# Descargar la última versión de SSMS que corrige CVE-2025-29803
# URL oficial Microsoft SSMS (ajusta según la versión más reciente)
$ssmsUrl = "https://aka.ms/ssmsfullsetup"
$ssmsInstaller = "$env:TEMP\SSMS-Setup.exe"

Write-Host "Descargando la actualización de SSMS..."
Add-Content -Path $logFile -Value "$(Get-Date) - Descargando SSMS desde $ssmsUrl"

Invoke-WebRequest -Uri $ssmsUrl -OutFile $ssmsInstaller

# Instalar actualización en modo silencioso
Write-Host "Instalando actualización..."
Add-Content -Path $logFile -Value "$(Get-Date) - Iniciando instalación silenciosa de SSMS"

Start-Process -FilePath $ssmsInstaller -ArgumentList "/install", "/quiet", "/norestart" -Wait

Write-Host "Mitigación completada. Revisa el log en $logFile"
Add-Content -Path $logFile -Value "$(Get-Date) - Mitigación completada exitosamente."
