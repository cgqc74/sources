# MitigarCVE_PSWindowsUpdate.ps1
# Instala KBs para mitigar CVEs y genera reporte en Windows Server 2022

# Ruta de logs
$logPath = "C:\Logs\Mitigaciones"
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$reportFile = Join-Path $logPath "Mitigacion_CVEs_$timestamp.csv"

# Crear carpeta de logs si no existe
if (-not (Test-Path $logPath)) { New-Item -ItemType Directory -Path $logPath -Force }

# Lista de CVEs y KBs
$CVE_KB = @{
    "CVE-2024-21386" = "KB5035855"
    "CVE-2021-43877" = "KB5008223"
    "CVE-2021-34532" = "KB5005575"
    "CVE-2021-1723"  = "KB5007206"
    "CVE-2020-1597"  = "KB5007206"
    "CVE-2020-1045"  = "KB4598230"
    "CVE-2022-41089" = "KB5019966"
    "CVE-2022-38013" = "KB5018419"
    "CVE-2022-34716" = "KB5016627"
    "CVE-2022-30184" = "KB5018421"
    "CVE-2022-29145" = "KB5014678"
    "CVE-2022-29117" = "KB5014678"
    "CVE-2022-24512" = "KB5011487"
    "CVE-2022-24464" = "KB5011497"
    "CVE-2022-23267" = "KB5009555"
    "CVE-2021-34485" = "KB5007206"
    "CVE-2021-31204" = "KB5007206"
    "CVE-2021-26701" = "KB5007206"
    "CVE-2021-31957" = "KB5004238"
    "CVE-2021-26423" = "KB5007206"
    "CVE-2021-24112" = "KB5009555"
    "CVE-2021-1721"  = "KB5007206"
}

# Instalar módulo PSWindowsUpdate si no existe
if (-not (Get-Module -ListAvailable -Name PSWindowsUpdate)) {
    Write-Host "Instalando módulo PSWindowsUpdate..."
    Install-Module PSWindowsUpdate -Force -Confirm:$false
}

Import-Module PSWindowsUpdate

$report = @()
Write-Host "=== Iniciando mitigación automatizada de CVEs ===" -ForegroundColor Cyan

foreach ($cve in $CVE_KB.Keys) {
    $kb = $CVE_KB[$cve]
    Write-Host "`nVerificando e instalando $cve ($kb)..." -ForegroundColor Yellow

    # Verificar si KB ya está instalado
    $installed = Get-WindowsUpdate -KBArticleID $kb -IsInstalled -ErrorAction SilentlyContinue

    if ($installed) {
        Write-Host "$kb ya está instalado." -ForegroundColor Green
        $mitigated = "Sí"
    } else {
        # Instalar KB
        try {
            Write-Host "Instalando $kb..." -ForegroundColor Cyan
            Install-WindowsUpdate -KBArticleID $kb -AcceptAll -IgnoreReboot -ErrorAction Stop
            # Verificar instalación
            $mitigated = if (Get-WindowsUpdate -KBArticleID $kb -IsInstalled) { "Sí" } else { "No" }
        }
        catch {
            Write-Host "Error instalando $kb: $_" -ForegroundColor Red
            $mitigated = "No"
        }
    }

    # Agregar al reporte
    $report += [PSCustomObject]@{
        CVE = $cve
        KB = $kb
        Instalado = if ($mitigated -eq "Sí") { "Sí" } else { "No" }
        Mitigado = $mitigated
    }
}

# Exportar reporte a CSV
$report | Export-Csv -Path $reportFile -NoTypeInformation -Encoding UTF8
Write-Host "`n=== Proceso finalizado ==="
Write-Host "Reporte generado en: $reportFile" -ForegroundColor Magenta
