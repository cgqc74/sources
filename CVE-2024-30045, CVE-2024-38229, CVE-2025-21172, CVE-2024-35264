# Fix-DotNet-Vulnerabilities.ps1
# Grupo: .NET Runtime
# CVEs: CVE-2024-30045, CVE-2024-38229, CVE-2025-21172, CVE-2024-35264

$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole("Administrators")
if (-not $isAdmin) {
    Write-Host "‚ö†Ô∏è  Ejecuta como Administrador." -ForegroundColor Red; exit 1
}

function Get-DotNetVersions {
    $paths = @(
        "C:\Program Files\dotnet\shared\Microsoft.NETCore.App"
        "C:\Program Files\dotnet\shared\Microsoft.WindowsDesktop.App"
    )
    $versions = @()
    foreach ($path in $paths) {
        if (Test-Path $path) {
            Get-ChildItem $path | Where-Object { $_.PSIsContainer } | ForEach-Object {
                try {
                    $versions += [PSCustomObject]@{
                        Product = (Split-Path $path -Leaf)
                        Version = [version]$_.Name
                        Path = $_.FullName
                    }
                } catch {}
            }
        }
    }
    return $versions
}

$cves = @(
    @{ Id="CVE-2024-30045"; Min="6.0.0"; Max="6.0.29"; Patch="6.0.29" }
    @{ Id="CVE-2024-38229"; Min="8.0.0"; Max="8.0.5";  Patch="8.0.5"  }
    @{ Id="CVE-2025-21172"; Min="6.0.0"; Max="6.0.31"; Patch="6.0.31" }
    @{ Id="CVE-2024-35264"; Min="7.0.0"; Max="7.0.17"; Patch="7.0.17" }
)

$installed = Get-DotNetVersions | Where-Object Product -eq "Microsoft.NETCore.App"
$updates = @()

foreach ($cve in $cves) {
    $min = [version]$cve.Min
    $max = [version]$cve.Max
    $patch = [version]$cve.Patch
    $vuln = $installed | Where-Object { $_.Version -ge $min -and $_.Version -lt $max }
    $vuln | ForEach-Object {
        $updates += [PSCustomObject]@{
            CVE = $cve.Id
            Current = $_.Version
            Target = $cve.Patch
        }
    }
}

if ($updates.Count -eq 0) {
    Write-Host "‚úÖ .NET: No hay vulnerabilidades." -ForegroundColor Green
} else {
    Write-Host "‚ö†Ô∏è  .NET: Se requieren actualizaciones:" -ForegroundColor Yellow
    $updates | Format-Table
    Write-Host "üí° Descarga desde: https://dotnet.microsoft.com/download/dotnet"
}
