# Escanea el sistema en busca de librerías SkiaSharp vulnerables al CVE-2024-5535
# https://nvd.nist.gov/vuln/detail/CVE-2024-5535

# Cambia esto si quieres limitar la búsqueda (por defecto es C:\)
$RootPath = "C:\"

# Versión segura mínima
$minSafeVersion = [Version]"2.88.6"

Write-Host "Buscando librerías SkiaSharp vulnerables al CVE-2024-5535 en $RootPath..." -ForegroundColor Cyan

# Buscar DLLs de SkiaSharp
$skiaDlls = Get-ChildItem -Path $RootPath -Recurse -Include SkiaSharp.dll -ErrorAction SilentlyContinue

foreach ($dll in $skiaDlls) {
    try {
        $file = [System.Diagnostics.FileVersionInfo]::GetVersionInfo($dll.FullName)
        $version = [Version]$file.FileVersion
        Write-Host "Encontrada DLL: $($dll.FullName) (versión $version)"
        if ($version -lt $minSafeVersion) {
            Write-Host "  --> VULNERABLE: Actualiza SkiaSharp a $minSafeVersion o superior." -ForegroundColor Red
        } else {
            Write-Host "  --> SEGURO" -ForegroundColor Green
        }
    } catch {
        Write-Host "  --> No se pudo obtener la versión de $($dll.FullName)" -ForegroundColor Yellow
    }
}

# Buscar paquetes NuGet de SkiaSharp
$skiaNupkgs = Get-ChildItem -Path $RootPath -Recurse -Include "SkiaSharp*.nupkg" -ErrorAction SilentlyContinue

foreach ($pkg in $skiaNupkgs) {
    if ($pkg.Name -match "SkiaSharp\.([0-9\.]+)\.nupkg") {
        $version = [Version]$Matches[1]
        Write-Host "Encontrado paquete NuGet: $($pkg.FullName) (versión $version)"
        if ($version -lt $minSafeVersion) {
            Write-Host "  --> VULNERABLE: Actualiza SkiaSharp a $minSafeVersion o superior." -ForegroundColor Red
        } else {
            Write-Host "  --> SEGURO" -ForegroundColor Green
        }
    }
}

# Buscar referencias en archivos de proyecto y packages.config
$skiaReferences = Select-String -Path "$RootPath\**\packages.config","$RootPath\**\*.csproj","$RootPath\**\*.fsproj" -Pattern "SkiaSharp" -ErrorAction SilentlyContinue

foreach ($ref in $skiaReferences) {
    $line = $ref.Line
    if ($line -match 'SkiaSharp[^\d]*([0-9\.]+)') {
        $version = [Version]$Matches[1]
        Write-Host "Referencia encontrada: $($ref.Path) (versión $version)"
        if ($version -lt $minSafeVersion) {
            Write-Host "  --> VULNERABLE: Actualiza SkiaSharp a $minSafeVersion o superior." -ForegroundColor Red
        } else {
            Write-Host "  --> SEGURO" -ForegroundColor Green
        }
    } else {
        Write-Host "Referencia sin versión clara en $($ref.Path): $line" -ForegroundColor Yellow
    }
}

Write-Host "`nEscaneo completado. Si ves advertencias en rojo, actualiza SkiaSharp a 2.88.6 o superior."
